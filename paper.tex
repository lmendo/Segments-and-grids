\documentclass[12pt, a4paper]{article}

\usepackage{mathptmx} % this doesn't have \jmath
%\usepackage{newtxtext, newtxmath} % I can't make this work
\usepackage{amsmath}
\usepackage{amsthm}
\usepackage[colorlinks,citecolor=blue,urlcolor=blue,linkcolor=blue,linktocpage=true]{hyperref}
%\RequirePackage{hypernat}
\usepackage{amssymb}
\usepackage{graphicx}
\usepackage[tight]{subfigure}
\usepackage{authblk}

\addtolength{\textheight}{28mm}
\addtolength{\voffset}{-17mm}
\addtolength{\textwidth}{-3mm}
\addtolength{\hoffset}{1.5mm}

%\arxiv{arXiv: ***}

\newcommand{\mr}{\mathrm}
\newcommand{\st}{\mid}%{\,|\,}
\newcommand{\cond}{\,|\,} % less spacing that \mid
\newcommand{\diff}{\,\mathrm d}
\let\Re\relax % remove the command...
\DeclareMathOperator{\Re}{Re} % ...to define it differently
\let\Im\relax
\DeclareMathOperator{\Im}{Im}
\DeclareMathOperator{\E}{E}
\newcommand{\funt}{\tau} % function that gives maximum number of touched tiles for real-valued length
\newcommand{\funl}{\lambda} % function that gives infimum real-valued length for a given number of touched tiles
\newcommand{\funti}{T} % function that gives maximum number of touched tiles for integer-valued length
\newcommand{\funli}{\Lambda} % function that gives minimum integer-valued length for a given number of touched tiles
\newcommand{\funta}{\varphi} % function that gives average number of touched tiles for real-valued length
\newcommand{\probmax}{\rho} % function that gives the probability of achieving the maximum number of touched tiles in the square case for real-valued length
\newcommand{\len}{\ell} % length variable, real-valued
\newcommand{\leni}{\ell} % length variable, integer-valued. Same notation, but I keep the different command just in case
\newcommand{\tiles}{t} % number of tiles (integer-valued)
\newcommand{\isolr}{i^+}
\newcommand{\jsolr}{j^+}
\newcommand{\isoli}{i^\ast}
\newcommand{\jsoli}{j^\ast}
\newcommand{\genfun}{q}
\newcommand{\genvar}{r}
\newcommand{\mss}{M}

\newtheorem{proposition}{Proposition}%[section]
\newtheorem{theorem}{Theorem}%[section]
\newtheorem{corollary}{Corollary}%[section]
%\newtheorem{lemma}{Lemma}%[section]

\makeatletter
\renewcommand\theenumi{(\@roman\c@enumi)} % this affects \ref's too
\renewcommand\labelenumi{\theenumi} % this doesn't affect \ref's
\makeatother

\graphicspath{{figures/}}


% !TeX spellcheck = en_GB
% This is so that TexStudio sets language automatically

\begin{document}

\title{
On the number of tiles visited by a\\
line segment on a rectangular grid
}

% Authors with different affiliations: from https://tex.stackexchange.com/a/370813/90222
\author[1]{Luis Mendo}
\author[2]{Alex Arkhipov}

\affil[1]{\small Universidad Polit\'ecnica de Madrid. \texttt{luis.mendo@upm.es}}
%Information Processing and Telecommunications Center, Universidad Polit\'ecnica de Madrid\\
%Avenida Complutense, 30. 28040 Madrid, Spain.\\
\affil[2]{\small **Affiliation, e-mail**}


%ORCID: Luis Mendo: 0000-0001-5691-714X

\maketitle

\begin{abstract}
***

\emph{Keywords:} ***.

%\emph{MSC2010:} 65C10, 65C50.
\end{abstract}


\section{Introduction}
\label{part: intro}

Given $a, b \in \mathbb R^+$, consider a grid on $\mathbb R^2$ formed by rectangular \emph{tiles} of width $a$ and height $b$. A line segment of length $\len \in \mathbb R^+$ is located on the plane with arbitrary position and orientation. The segment is said to \emph{visit} a tile if it intersects its interior.\footnote{
The definition uses the interior of the tile, excluding the border, to avoid uninteresting results such as a ``zero-length'' segment visiting (a vertex of) $4$ tiles.} This paper deals with the following problems:
\begin{itemize}
\item What is the maximum number of tiles that the segment can visit? Conversely, what length should a segment have to visit a given number of tiles?
\item What is the average number of tiles visited by a uniformly random segment of a given length? How often does the random segment visit the maximum number of tiles?
\end{itemize}

As an example of the first question, consider $a=1.35$, $b=1$. A segment of unit length can be placed as shown in Figure~\ref{fig: examples} (left) to make it visit $3$ tiles. In fact, this is the maximum number for $\len=1$. The figure also illustrates that the solution for length $2.4$ is $5$ (center), and for $4.7$ it is $8$ (right).

\begin{figure}
\centering%
\includegraphics[width=.85\textwidth]{examples_1p35}%
\caption{Examples for $a=1.35$, $b=1$; $\len=1$, $\len=2.4$ and $\len=4.7$
}%
\label{fig: examples}%
\end{figure}%

An equivalent formulation of the problem is obtained allowing segments of length $\len$ \emph{or smaller}. The equivalence is clear from the fact that reducing the length cannot increase the number of visited tiles. Either of these formulations will be referred to as the \emph{direct} problem.

The \emph{inverse} problem is, given $\tiles \in \mathbb N$, to determine the infimum length of all segments that visit at least $\tiles$ tiles. For real-valued lengths this infimum is not a minimum, because given a segment that visits $\tiles$ tiles, its length can always be reduced by some non-zero amount without changing the number of visited tiles. This is a consequence of the interior of each tile being an open set.

The direct and inverse problems are closely related. Namely, if $\len$ is the infimum of all lengths that allow visiting at least $\tiles$ tiles (inverse problem), $\tiles$ is the maximum number of tiles that can be visited with lengths slightly greater than $\len$ (direct problem).

To address the remaining two questions, the notion of a \emph{random} segment of a given length needs to be precisely defined. This is done as follows. By symmetry, one endpoint of the segment can be assumed to lie in a fixed, reference tile. The position of this endpoint is \emph{uniformly} distributed on the tile. The segment orientation has a \emph{uniform} distribution on the set of all possible directions, and is \emph{independent} of the endpoint position. Solving the problem of how many tiles the segment visits on average, as will be seen, also answers the inverse question (segment length to visit a given number of tiles on average). A natural, related question is with that probability the segment visits the maximum number of tiles. 

% ***Do we need to discuss potential applications of this (if we can find any)? This probably depends on the journal
% ***Do we need a section with conclusions? Probably not; depends on the journal

The problems studied in this paper are related to Buffon's needle problem and Laplace's extension of it. Buffon's original 1733 problem considers tossing a needle of length $\len$ onto ruled paper with parallel lines a height $b$ apart, and asks what is the probability of the needle crossing a line if it lands in a uniformly random position and orientation. For a needle of length $\len = b$, this is $2/\pi$, and hence repeated trials of this experiment can be used to estimate $\pi$. This is generalized in \cite{Ramaley69} to $\frac{2\len}{\pi b}$ for the expected number of crossings of a needle which might multiple lines.

The Buffon-Laplace needle problem considers a needle tossed onto a grid of rectangular tiles of width $a$ and height $b$. The number of visited tiles equals one plus the number of crossings with probability 1, as shown in Proposition \ref{prop: 
i+j-1}. The probability of the needle staying within a single rectangle, that is visiting only one tile, is computed in \cite{Arnow94} for the case where $\len < \min(a,b)$. This work considers the complementary question of the chance that the needle visits the maximum number of tiles possible for its length, described by a formula in Theorem~\ref{theo: probmax, sq}.

%  \ldots ***maybe a short paragraph here mentioning related problems: Buffon's needle, Buffon-Laplace problem. Some references: \cite{Ramaley69}, \cite{Arnow94}, \cite{Mathai99}. 
% Alex: Mentioned Ramaley69 and Arnow94, not sure where Mathai99 fits in
%\url{https://www.jstor.org/stable/2317945}
%\url{https://www.jstor.org/stable/2687085}

The rest of the paper is organized as follows. Fundamental results are presented in \S\ref{part: fund results}, which form the basis of the subsequent analysis. The direct and inverse problems for a deterministic segment are considered in \S\ref{part: max}, first for arbitrary grids and then for a square grid. The analysis for the random segment is carried out in \S\ref{part: rand}. The average number of tiles is computed for arbitrary grids, and the probability that the segment visits the maximum number of tiles is obtained for a square grid.

% The rounding down (floor) and rounding up (ceiling) operations will be denoted as $\lfloor \cdot \rfloor$ and $\lceil \cdot \rceil$. The notation $[\mathsf S]$ will be used for the Iverson function, which equals $1$ if statement $\mathsf S$ is true and $0$ otherwise.


\section{Fundamentals}
\label{part: fund results}

For a grid with horizontal spacing $a$ and vertical spacing $b$, lines of the form $x = ka$ or $y = kb$ with $k \in \mathbb Z$ will be called \emph{grid lines}. A \emph{tile} is delimited by two pairs of consecutive horizontal and vertical grid lines. The intersection points of horizontal and vertical grid lines will be called \emph{grid points}. These correspond to vertices of the tiles.

Every segment has an associated \emph{canonical rectangle}, which is the minimum-size rectangle that is formed by grid lines and contains the segment. More specifically, if the segment has endpoints $(x_1,y_1)$, $(x_2,y_2)$, where $x_1, x_2, y_1, y_2 \in \mathbb R$, its canonical rectangle has lower-left corner and upper-right corner given as
\begin{align*}
& (\lfloor\min\{x_1, x_2\}/a\rfloor a, \lfloor\min\{y_1,y_2\}/b\rfloor b), \\
& (\lceil\max\{x_1, x_2\}/a \rceil a, \lceil\max\{y_1,y_2\}/b \rceil b).
\end{align*}
The dimensions of the canonical rectangle, normalized to the tile width and height respectively, are two integer numbers $i$, $j$. Two examples are illustrated in Figure~\ref{fig: canonical rectangle and touched tiles}, both with $i=5$, $j=4$. Clearly, all tiles visited by the segment are contained in the canonical rectangle. Note also that the canonical rectangle can have $i=0$ or $j=0$ if the segment coincides with part of a grid line.

\begin{figure}
\centering%
\subfigure[The segment does not pass through any interior grid points]{%
\label{fig: S_nogridpoints}%
\includegraphics[width=.49\textwidth]{S_nogridpoints_1p35}%
}\hfill%
\subfigure[The segment passes through some interior grid points]{%
\label{fig: S_gridpoints}%
\includegraphics[width=.49\textwidth]{S_gridpoints_1p35}%
}%
\caption{Canonical rectangle and visited tiles
}%
\label{fig: canonical rectangle and touched tiles}%
\end{figure}%

\begin{proposition}
\label{prop: i+j-1}
Consider an arbitrary segment, and let $i, j$ respectively denote the normalized width and height of its canonical rectangle. If $i, j \geq 1$, the number of tiles visited by the segment is at most $i+j-1$. This bound is attained if and only if the segment does not pass through any grid point in the interior of the rectangle.
\end{proposition}

\begin{proof}
The segment visits, by definition, two tiles in opposite corners of the canonical rectangle. It can be assumed, without loss of generality, that those tiles are in the lower-left and upper-right corners of the rectangle, as in Figure~\ref{fig: canonical rectangle and touched tiles}. The visited tiles can be thought of as following a path within the canonical rectangle. Starting at the lower-left tile, the next tile can be the one to the left, the one above, or the one above and to the left. The latter case occurs if and only if the segment passes through the grid point between those two tiles.

Since the segment follows a straight line, once it ``leaves'' a row of tiles in its path from the lower-left to the upper-right corner, it can never visit any more tiles from that row. The same observation applies to the columns.

This implies that the maximum number of visited tiles is $i+j-1$, which is attained if and only if the segment avoids all grid points in the interior of the canonical rectangle, as in Figure~\ref{fig: S_nogridpoints}. Note that grid points at the corners of the rectangle do not count for this; and that the segment cannot pass through any other grid points on the rectangle border, because that would imply $i=0$ or $j=0$. Figure~\ref{fig: S_gridpoints} illustrates a case where the maximum is not attained.
\end{proof}

\begin{proposition}
\label{prop: len ineq i j}
Consider $a, b, \len \in \mathbb R^+$ and $i, j \in \mathbb N$, $i, j \geq 2$ arbitrary.
\begin{enumerate}
\item
\label{prop: len ineq i j: ineqs}
The following inequalities hold for any segment with length $\len$ whose canonical rectangle has normalized dimensions $i, j$:
\begin{align}
\label{eq: len > sqrt}
\len &> \sqrt{(i-2)^2 a^2 + (j-2)^2 b^2}, \\
\label{eq: len leq sqrt}
\len &\leq \sqrt{i^2 a^2 + j^2 b^2}.
\end{align}
\item
\label{prop: len ineq i j: exist}
Conversely, if $\len$, $i$, $j$ satisfy \eqref{eq: len > sqrt} and \eqref{eq: len leq sqrt} there exists a segment of length $\len$ whose canonical rectangle has normalized dimensions $i$ and $j$.
\item
\label{prop: len ineq i j: ineq, exist}
There is a segment of length not exceeding $\len$ that has a canonical rectangle with normalized dimensions $i, j$ if and only if \eqref{eq: len > sqrt} holds.
\end{enumerate}
\end{proposition}

\begin{proof}
\ref*{prop: len ineq i j: ineqs} The inequalities follow from the fact that the segment endpoints lie in the interiors or on the outer edges of two tiles in opposite corners of the canonical rectangle. This is illustrated in Figures~\ref{fig: len ineq 4 3} and \ref{fig: len ineq 4 2} for two specific $(i,j)$ pairs respectively. For each $(i,j)$, segments are shown with lengths close to either of the two bounds. Note that \eqref{eq: len > sqrt} is valid even for $i=2$, $j=2$, in which case it reduces to $\len>0$.

\ref*{prop: len ineq i j: exist} For $a$, $b$, $\len$, $i$, $j$ satisfying the two inequalities, a segment of length $\len$ can be found that has its endpoints in the interiors or on the outer edges of the two shaded tiles of a rectangle of normalized dimensions $i$ and $j$, as in Figure~\ref{fig: len ineq i j}. Therefore this segment has the given rectangle as canonical.
\begin{figure}
\centering%
\subfigure[$i=4$, $j=3$]{%
\label{fig: len ineq 4 3}%
\includegraphics[width=.49\textwidth]{L_ineq_4_3_1p35}%
}\hfill%
\subfigure[$i=4$, $j=2$]{%
\label{fig: len ineq 4 2}%
\includegraphics[width=.49\textwidth]{L_ineq_4_2_1p35}%
}%
\caption{Relationship between segment length $\len$ and dimensions $i$, $j$ of the canonical rectangle
}%
\label{fig: len ineq i j}
\end{figure}%

\ref*{prop: len ineq i j: ineq, exist} ``\eqref{eq: len > sqrt} $\Rightarrow$ there is a segment\ldots'': Assume that \eqref{eq: len > sqrt} holds. It is always possible to choose a length equal to or smaller than $\len$ such that both \eqref{eq: len > sqrt} and \eqref{eq: len leq sqrt} hold. The result follows, for that length, from part~\ref{prop: len ineq i j: exist}.

``There is a segment\ldots $\Rightarrow$ \eqref{eq: len > sqrt} '': Assume that a segment exists with length not exceeding $\len$ and with a canonical rectangle with normalized dimensions $i$, $j$. From part~\ref{prop: len ineq i j: ineqs}, inequality \eqref{eq: len > sqrt} holds for that segment length, and thus for $\len$.
\end{proof}

According to Proposition~\ref{prop: i+j-1}, in order to maximize the number of visited tiles for a given length, the position and orientation of the segment should be chosen to obtain $i+j-1$ as large as possible, where $i$ and $j$ are the normalized dimensions of its canonical rectangle. On the other hand, Proposition~\ref{prop: len ineq i j} restricts the $i, j$ values that can be achieved with a given length. A relevant question is: are there any $(i,j)$ pairs that can be disregarded irrespective of the length $\len$? In other words, what is the ``smallest'' subset of $\mathbb N^2$ such that the $(i,j)$ pair that maximizes the number of tiles for any given length can always be found within that subset? A subset that contains a maximizing $(i,j)$ for any length will be called a \emph{sufficient} set. Clearly, this set must contain at least one such pair for each possible value of $i+j-1$, so that the set can produce that value as solution (for certain lengths). A sufficient set that contains exactly one pair $(i,j)$ for each value of $i+j-1$ will be called a \emph{minimal sufficient} set.

For instance, it is intuitively clear from Figure~\ref{fig: examples} that segment orientations near the vertical or horizontal directions (resulting in $i=1$ with large $j$, or $j=1$ with large $i$) will not maximize the number of visited tiles.
% This is true for any a, b: 2 can achieved instead of 1 without compromising the other dimension.
The corresponding $(i,j)$ pairs can be left out of the sufficient set. In general, the pairs included in a minimal sufficient set will be different depending on $a$ and $b$. Two specific examples of minimal sufficient sets will be presented later in this section.

% ***Is the text from here to the proposition too long? Shorten it?

% ***AA: Do we actually need the concept of a minimal sufficient set, given that there's a single value at each diagonal (tiebreaking a certain way)? Perhaps rename to suggest it's one value?

Knowing a minimal sufficient set of $(i,j)$ pairs facilitates the solution of both the direct an inverse problems, because it reduces the number of pairs that need to be tried. In order to derive a general method to build a minimal sufficient set, it is insightful to consider two specific cases first. It is also convenient to use the equivalent formulation of the direct problem referred to in \S\ref{part: intro}, i.e.~finding the maximum number of tiles visited by segments of length $\len$ \emph{or less}.

% Thus each choice of $(i, j)$ implies a maximum of $i+j-1$ visited tiles on one hand; and sets a lower bound on the required length $\len$ on the other hand.

Consider first $a=b=1$. This is illustrated in Figure~\ref{fig: ijLS_1}. Note that in this and in the next figures the axes represent $ia$ and $jb$ (not $i$ and $j$). Each dashed diagonal line joins $(i, j)$ pairs with the same $i+j-1$. The radius of each arc represents the lower bound on $\len$ given by \eqref{eq: len > sqrt}, for certain $(i,j)$ pairs, which are marked with filled circles (these pairs form a minimal sufficient set, as will be seen).

\begin{figure}
\centering%
\includegraphics[width=.7\textwidth]{ijLS_1}%
\caption{Relationship of segment length and number of visited tiles with the width and height of the canonical rectangle, for $a=b$
}%
\label{fig: ijLS_1}%
\end{figure}%
% ***Maybe combine this figure and the next into one figure with two subfigures (stacked vertically, size similar to now). Not sure. It has been done in others
% ***Are these figures necessary? They were created with the aim of helping understand the first of the two propositions on $\mss$. Now that proposition has been removed. They are probably still useful, but maybe the text about these figures needs to be rewritten.

For a given $\len \in \mathbb R^+$, the $(i,j)$ pairs that can be achieved with segments of length not exceeding $\len$ are, by Proposition~\ref{prop: len ineq i j}.\ref{prop: len ineq i j: ineq, exist}, those whose distance from $(2a,2b)$ is less than $\len$, i.e.~those delimited by the corresponding arc. It is clear from the figure that for $i+j-1$ odd, if some point $(i',j')$ with $|i'-j'|>1$ is achievable with the length bound $\len$, then necessarily there is a point $(i'',i'')$ with the same number of visited tiles $i+j-1$ (same diagonal line) that is also achievable with the same length restriction (because it has smaller distance to $(2a,2b)$). Similarly, for $i+j-1$ even, if a point $(i',j')$ with $|i'-j'|>1$ is achievable, then there is a point $(i'',i''-1)$ in the same diagonal that is also achievable with the same length restriction.

Thus for $a=b=1$, a minimal sufficient set is formed by the pairs $(i,j)$ with $j=i$ or $j=i+1$. Observe that due to symmetry, any point $(i'',i''-1)$ could be replaced by $(i''-1,i'')$. This illustrates that the minimal sufficient set is not unique in general. 

The pairs in the minimal sufficient set are marked with filled circles in Figure~\ref{fig: ijLS_1}. Given a length $\len$, the maximum number of visited tiles will be achieved with one of those pairs, namely that in the diagonal line furthest from $(2a,2b)$ that is within the circle with radius $\len$ centered at that point.

As a second example, consider $a=1.35$, $b=1$. This is depicted in Figure~\ref{fig: ijLS_1p35}. In this case the minimal sufficient set does not follow a rule as simple as in the previous example.

\begin{figure}
\centering%
\includegraphics[width=.7\textwidth]{ijLS_1p35}%
\caption{Relationship of segment length and number of visited tiles with the width and height of the canonical rectangle, for $a=1.35b$
}%
\label{fig: ijLS_1p35}%
\end{figure}%

The following proposition gives an explicit method to obtain a minimal sufficient set, $\mss = \{(i_3,j_3), (i_4.j_4), \ldots\}$, where the pair $(i_\tiles,j_\tiles)$ corresponds to $i+j-1 = \tiles$.

\begin{proposition}
\label{prop: min suff set, form}
Given $a, b \in \mathbb R^+$ and $\tiles \in \mathbb N$, $\tiles \geq 3$, a minimal sufficient set $\mss = \{(i_3,j_3), (i_4.j_4), \ldots\}$ can be obtained as
\begin{align}
\label{eq: min suff set, form, i}
i_\tiles &= \left\lfloor \frac {(2\tiles-1)b^2+5a^2}{2(a^2+b^2)} \right\rfloor, \\
\label{eq: min suff set, form, j}
j_\tiles &= \left\lceil \frac {(2\tiles-3) a^2 + 3b^2}{2(a^2+b^2)} \right\rceil,
% ***change expressions to the following to match the statement of Theorem~\ref{theo: funl, form}:
%i_\tiles &= \left\lfloor \frac{b^2 (\tiles-3)}{a^2+b^2} + \frac 5 2 \right\rfloor \\
%j_\tiles &= \left\lceil  \frac{a^2 (\tiles-3)}{a^2+b^2} + \frac 3 2 \right\rceil
\end{align}
where $i_\tiles + j_\tiles-1 = \tiles$. All pairs $(i_\tiles,j_\tiles)$ are strictly below the line
\begin{equation}
\label{eq: upper bound, line}
j = \frac{i a^2}{b^2} - \frac{3a^2}{2b^2} + \frac 5 2,
\end{equation}
and above or on the line
\begin{equation}
\label{eq: lower bound, line}
j = \frac{i a^2}{b^2} - \frac{5a^2}{2b^2} + \frac 3 2.
\end{equation}
\end{proposition}

\begin{proof}
***New proof based on treating i,j as continuous along the line i+j=constant, then quantizing to the nearest allowed point along that line. We should use the notation $\isolr$, $\jsolr$ for the continuous coordinates, in conformity to other proofs that use continuous coordinates.
% ***The continuous argument gives something like $i-2 = b^2/(a^2+b^2)*(t-3)$, $j-2 = a^2/(a^2+b^2)*(t-3)$. We then compute how much the distance from $(i,j)$ to $(2,2)$ is increased by quantizing along the i+j line, to argue that the nearest quantized point should be chosen. To ensure that in case of a tie we choose the point with larger $i$, we apply floor(...+1/2) to i and ceiling(...-1/2) to j.
% ***Reference the figure in the text. The figure is an example with $a=1.35$, $b=1$, $\tiles=7$. It contains the line j-2 = a^2/b^2*(i-2), whose intersection with i+j-1=t (which is perpendicular to it) gives the continuous solution $(\isolr, \jsolr)$ (marked with a square). 

***The bounding lines are a direct consequence of how $i_\tiles$ and $j_\tiles$ are obtained.

\begin{figure}%
\centering%
\includegraphics[width=.7\textwidth]{mss}%
\caption{Obtaining $(\isolr, \jsolr)$ and $(i_\tiles, j_\tiles)$ in  Proposition~\ref{prop: min suff set, form}. Example with $a=1.35$, $b=1$, $\tiles=7$%
}%
\label{fig: min suff set, form}%
\end{figure}%
\end{proof}

The bounding lines in Proposition~\ref{prop: min suff set, form} are shown in Figure~\ref{fig: pairs_bounds}, using three different pairs of grid parameters $a$, $b$ as examples. Given $(i_\tiles,j_\tiles) \in \mss$, the next pair $(i_{\tiles+1},j_{\tiles+1})$ is obtained by incrementing $j$ if that results in a point below \eqref{eq: upper bound, line}. Else $i$ is incremented instead, and the new pair is guaranteed to be above or on \eqref{eq: lower bound, line}.

\begin{figure}
\centering%
\subfigure[$a = 1$, $b = 1$]{%
\label{fig: pairs_bounds_1}%
\includegraphics[height=.24\textheight]{pairs_bounds_1}% *!*
}\hfill%
\subfigure[$a = 1.35$, $b = 1$]{%
\label{fig: pairs_bounds_1p35}%
\includegraphics[height=.24\textheight]{pairs_bounds_1p35}% *!*
}\hfill%
\subfigure[$a = \sqrt{2}$, $b = 1$]{%
\label{fig: pairs_bounds_sqrt2}%
\includegraphics[height=.24\textheight]{pairs_bounds_sqrt2}% *!*
}%
\caption{Minimal sufficient set $\mss$ and bounding lines
}%
\label{fig: pairs_bounds}%
\end{figure}%
 
For $a^2/b^2$ arbitrary, the number of pairs with the same $i$ coordinate, or with the same $j$, in the set $\mss$ is in general irregular, because the lines \eqref{eq: upper bound, line} and \eqref{eq: lower bound, line} do not follow a ``natural''
% ***it may be better to say ``simple'' instead of ``natural'', specially if we rename ``canonical`'' to ``natural'' or ``natural bounding''
direction of the grid. This happens for instance in Figure~\ref{fig: pairs_bounds_1p35}, where the number of pairs for the first $i$ values equals either $2$ or $3$ without a clear pattern.\footnote{Strictly, there is a periodic pattern whenever $a^2/b^2$ is rational, which is the case in Figure~\ref{fig: pairs_bounds_1p35}. However, this is not easily discernible unless $a^2/b^2$ is a ratio of small numbers.}
On the other hand, a simple pattern arises when $a^2/b^2$ or $b^2/a^2$ is a natural number, as seen in Figures~\ref{fig: pairs_bounds_1} and \ref{fig: pairs_bounds_sqrt2}.

A segment whose canonical rectangle has normalized width $i$ and height $j$ is oriented with approximate slope $jb/(ia)$ with respect to the $x$ axis (see Figure~\ref{fig: len ineq i j}); and the approximation becomes better for greater segment lengths. From \eqref{eq: upper bound, line} and \eqref{eq: lower bound, line} it can be seen that the positions of the pairs $(i,j) \in \mss$ have $j/i \approx a^2/b^2$ for large $i, j$. Therefore the optimal slope for long segments is approximately $a/b$. This formalizes the intuition that to maximize the number of visited tiles, the segment should follow a direction along which the perceived ``length'' of the tile is smaller.
% but not ``smallest'', if that were the case it would always be either vertical or horizontal


\section{Direct and inverse problems for a deterministic segment}
\label{part: max}

The direct and inverse problems defined in \S\ref{part: intro}, considering the segment position and orientation as deterministic, are addressed in this section. The general case for rectangular grids with real-valued segment lengths is analyzed first, in \S\ref{part: max: arbitrary grid, real lengths}. The particular case of square grids is addressed in \S\ref{part: max: unit square grid, real lengths}, as it allows a specialized formula for the direct problem. Lastly, the analysis of a unit square grid with integer-valued lengths is presented in \S\ref{part: max: unit square grid, integer lengths}.


\subsection{Arbitrary grid with real-valued lengths}
\label{part: max: arbitrary grid, real lengths}

For a grid with parameters $a, b \in \mathbb R^+$, the maximum number $\tiles$ of visited tiles with a given real-valued length $\len$ can be represented by a function $\funt: \mathbb R^+ \to \mathbb N$ such that $\tiles = \funt(\len)$. Similarly, for the inverse problem a function $\funl: \mathbb N \to \mathbb R^+$ can be defined such that $\funl(\tiles)$ gives the infimum length of all segments that visit at least $\tiles$ tiles.

The function $\funt$ can be obtained from $\funl$ by noting that the maximum number of tiles that can be visited by a segment of length $\len$ is the index of the largest term of the sequence $\funl(\tiles)$ that is less than $\len$:
\begin{equation}
\label{eq: funt funl}
\funt(\len) = \max \{\tiles \in \mathbb N \st \funl(\tiles)<\len\}.
\end{equation}
Conversely, $\funl$ can be obtained from $\funt$ as
\begin{equation}
\label{eq: funl funt}
\funl(\tiles) = \inf\{\len \in \mathbb R^+ \st \funt(\len) \geq \tiles\}.
\end{equation}

For arbitrary $a, b \in \mathbb R^+$, the functions $\funt$ and $\funl$ can be computed using an iterative procedure, which exploits the fact that the pairs $(i_3,j_3), (i_4,j_4), \ldots$ of $\mss$ are sorted by increasing $i+j-1$, and also by increasing $(i-2)^2 a^2 + (j-2)^2 b^2$. Namely, for $\funt$ the following procedure yields the solution: generate successive pairs to find the last one, $(i_\tiles,j_\tiles)$, that satisfies \eqref{eq: len > sqrt}; then $\funt(\len) = \tiles$. For $\funl$ the analogous method gives a direct formula. In addition, it is possible to obtain a direct formula also for $\funt$ using a different approach. These formulas are given in Theorems \ref{theo: funt, form} and \ref{theo: funl, form}.

\begin{theorem}
\label{theo: funt, form}
For $a, b \in \mathbb R^+$, $a \geq b$ and $\len \in \mathbb R^+$,
\begin{equation}
\label{eq: theo: funt, form; funt}
\funt(\len) = \isoli+\jsoli-1
\end{equation}
with
\begin{align}
\label{eq: theo: funt, form; i}
\isoli &= \left\lceil \frac{a + b \Re \sqrt{4\len^2/(a^2+b^2)-1}}{2a} \right\rceil + 1, \\
\label{eq: theo: funt, form; j}
\jsoli &= \left\lceil \frac{\sqrt{\len^2-(\isoli-2)^2a^2}}{b} \right\rceil + 1.
\end{align}
The function $\funt$ is piecewise constant and left-continuous, with unit-height jumps. A jump occurs at $\len$ if and only if $\len = \funl(\tiles)$ for some $\tiles \in \mathbb N$, $\tiles \geq 4$; and then $\funt(\len) = \tiles-1$, $\lim_{h \rightarrow 0+} \funt(\len+h) = \tiles$.
\end{theorem}

\begin{proof}
The approach is similar to that used in Proposition~\ref{prop: min suff set, form}. Namely, for $i, j \geq 2$ the intersection $(\isolr, \jsolr)$ of the line \eqref{eq: lower bound, line} and the arc centered at $(2a,2b)$ with radius $\len$ is found, and from that the actual integer solution $(\isoli, \jsoli)$ is computed.

More specifically, assuming that \eqref{eq: lower bound, line} holds, the largest $i$ that can be achieved with lengths not exceeding $\len$ is obtained, as given by Proposition~\ref{prop: len ineq i j}.\ref{prop: len ineq i j: ineq, exist}. This value, $\isoli$, is computed by rounding down $\isolr$. Then, assuming that $i = \isoli$, the largest $j$ allowed by Proposition~\ref{prop: len ineq i j}.\ref{prop: len ineq i j: ineq, exist}, $\jsoli$, is obtained. As will be seen, in some cases the resulting $(\isoli,\jsoli)$ is in $\mss$, and in other cases it is not. However, in either case $(\isoli,\jsoli)$ has the largest $i+j-1$ sum that can be achieved with segments of length up to $\len$. Thus the desired result is $\isoli+\jsoli-1$.

The two possibilities are illustrated in Figure~\ref{fig: ijLS_1p35_detail} for $a=1.35$, $b=1$. In each case, the arc displayed in the graph is centered at $(2a,2b)$ and has radius $\len$. The inner region defined by the arc contains all $(i,j)$ pairs that are achievable according to Proposition~\ref{prop: len ineq i j}.\ref{prop: len ineq i j: ineq, exist}. As in previous figures, filled circles represent $(i,j)$ pairs that are in $\mss$, and empty circles are those that do not belong to $\mss$. The solid line is \eqref{eq: lower bound, line}. The intersection point $(\isolr, \jsolr)$ is displayed with a square marker.

\begin{figure}
\centering%
\subfigure[$\len = 3.1$: $(\isoli,\jsoli) \in \mss$]{%
\label{fig: ijLS_1p35_detail_in}%
\includegraphics[width=.7\textwidth]{ijLS_1p35_detail_in}%
}\\%\hfill%
\subfigure[$\len = 3.7$: $(\isoli,\jsoli) \notin \mss$]{%
\label{fig: ijLS_1p35_detail_notin}%
\includegraphics[width=.7\textwidth]{ijLS_1p35_detail_notin}%
}%
\caption{Obtaining $(\isoli,\jsoli)$ in Theorem~\ref{theo: funt, form}. Examples with $a=1.35$, $b=1$%
}%
\label{fig: ijLS_1p35_detail}%
\end{figure}%

The point $(\isolr, \jsolr)$ can be obtained as a solution of the equation system
\begin{align}
\label{eq: icont jcont 1}
(\isolr-2)^2 a^2 + (\jsolr-2)^2 b^2 &= \len^2, \\
\label{eq: icont jcont 2}
\jsolr = \frac{\isolr a^2}{b^2} - \frac{5a^2}{2b^2} + \frac 3 2.
\end{align}
Substituting \eqref{eq: icont jcont 2} into \eqref{eq: icont jcont 1} yields a quadratic equation for $\isolr$,
\begin{equation}
\label{eq: quadratic, i}
4a^2(\isolr-2)^2 - 4a^2(\isolr-2) + a^2+b^2-\frac{4\len^2 b^2}{a^2+b^2},
\end{equation}
which can have zero, one or two real-valued solutions (this respectively means that the line is exterior, tangent or secant to the circle \eqref{eq: icont jcont 1}). Only the solution with $\isolr, \jsolr \geq 2$, if any, is of interest. This solution can only exist as the one with largest $\isolr$ value when there are real-valued solutions, and it is obtained as
\begin{equation}
\label{eq: icont jcont 3}
\isolr = \frac{a + b \sqrt{4\len^2/(a^2+b^2)-1}}{2a} + 2.
\end{equation}

The case with no real-valued solutions to \eqref{eq: quadratic, i} corresponds to $\len < \sqrt{a^2+b^2}/2$. Since $a \geq b$, this implies that $\len < a$. Thus any achievable $(i,j)$ pair, if any, will have $i=2$. Therefore in this case $\isoli$ should be set to $2$; and then the maximum achievable $\jsoli$ will be obtained from \eqref{eq: icont jcont 2}.

If \eqref{eq: quadratic, i} has two real-valued solutions or one real-valued double solution, which is the case when $\len \geq \sqrt{a^2+b^2}/2$, the largest solution will have $\jsolr < 2$ if $\isolr < (b^2/a^2+5)/2$, as can be seen setting $\jsolr=2$ in \eqref{eq: icont jcont 2}; or equivalently if $\sqrt{a^2+b^2}/2 \leq \len < (a^2+b^2) / (2a)$, as can be seen substituting $\jsolr < 2$ and $\isolr < (b^2/a^2+5)/2$ in \eqref{eq: icont jcont 1}. Since $\isolr < (b^2/a^2+5)/2 < 3$ for $a \geq b$, only pairs with $i=2$ are achievable in this case again, and thus the solution $\isoli$ should also be $2$.

Lastly, for $\len \geq (a^2+b^2) / (2a)$ the expressions \eqref{eq: icont jcont 2} and \eqref{eq: icont jcont 3} give $\isolr, \jsolr \geq 2$, and $\isoli$ should be taken as the greatest integer less than $\isolr$, i.e.~$\lceil \isolr \rceil-1$.
 
The three cases are unified by taking the real part of \eqref{eq: icont jcont 3} and computing $\isoli = \lceil \isolr \rceil-1$, as is easily checked. This gives \eqref{eq: theo: funt, form; i}. Once $\isoli$ is known, $\jsoli$ is computed, according to \eqref{eq: theo: funt, form; j}, as the greatest integer such that $(\isoli,\jsoli)$ is within the arc determined by $\len$. This ensures that $(\isoli,\jsoli)$ is achievable with lengths less than $\len$.

There are two possibilities for the point $(\isoli,\jsoli)$, as stated at the outset. These are illustrated in Figures~\ref{fig: ijLS_1p35_detail_in} and \ref{fig: ijLS_1p35_detail_notin} respectively. The first possibility is that $(\isoli,\jsoli) \in \mss$ (Figure~\ref{fig: ijLS_1p35_detail_in}). Then, by construction  $(\isoli,\jsoli)$ maximizes $i+j-1$ among all achievable pairs of $\mss$, and is therefore optimal.

The second possibility is that $(\isoli,\jsoli) \notin \mss$ (Figure~\ref{fig: ijLS_1p35_detail_notin}). This happens when the point from $\mss$ that has $i = \isoli$ ($(4,5)$ in the figure) is outside the arc, i.e.~it would require a length greater than $\len$. The selected point  $(\isoli,\jsoli)$ ($(4,4)$ in the figure), however, has the same $i+j-1$ sum as the point from $\mss$ that ``should'' be used, which is $(\isoli-1,\jsoli+1)$ ($(3,5)$ in the figure); and therefore gives the same result. This is always the case, because  $(\isoli,\jsoli+1) \in \mss$ (it is above or on the bounding line) and $(\isoli,\jsoli) \notin \mss$ (it is below the line), and due to how $\mss$ has been constructed, this implies that $(\isoli-1,\jsoli+1) \in \mss$ and $(\isoli-1,\jsoli+k) \notin \mss$ for $k =2, 3, \ldots$.  Therefore, $(\isoli,\jsoli)$ is achievable and maximizes $i+j-1$, which implies that $\isoli+\jsoli-1$ is the desired solution.

Therefore, whether $(\isoli,\jsoli) \in \mss$ or $(\isoli,\jsoli) \notin \mss$, equations \eqref{eq: theo: funt, form; i} and \eqref{eq: theo: funt, form; j} give $\isoli+\jsoli-1$ equal to $\funt(\len)$, as claimed.

It should be noted that for the specific case that $a^2/b^2 = 2k-1$, $k \in \mathbb N$ the lower bounding line \eqref{eq: lower bound, line} becomes $j = i(2k-1)-5k+4$, which gives integer $j$ for integer $i$. This means that the bound is actually achieved for all pairs in $\mss$ (see for example Figure~\ref{fig: pairs_bounds_1}), and the case $(\isoli,\jsoli) \notin \mss$ never occurs. Thus, when $a^2/b^2$ is an odd integer the obtained $(\isoli,\jsoli)$ is guaranteed to be in $\mss$, whereas for general $a^2/b^2$ either $(\isoli,\jsoli)$ or $(\isoli-1,\jsoli+1)$ are in in this set.
% ^ If this is needed outside of the proof, it can be included at the end of the theorem statement

As for the properties of $\funt$, it follows from \eqref{eq: theo: funt, form; funt}--\eqref{eq: theo: funt, form; j} that this function is piecewise constant and left-continuous. From the procedure described in the previous paragraphs for obtaining $(\isoli, \jsoli)$ it is clear that $\isoli+\jsoli-1$ increases in steps of $1$ when $\len$ is increased continuously; that is, $\funt$ has jumps of unit height.

Consider an arbitrary $\len$ such that for some $\tiles \in \mathbb N$, $\tiles \geq 4$
\begin{equation}
\label{eq: theo funt, form: prop 1}
\funl(\tiles)=\len.
\end{equation}
To see that $\funt$ has a jump at $\len$, assume for the sake of contradiction that $\funt$ is continuous, therefore constant, at that point. Then there is $\epsilon > 0$ for which $\funt(\len+\epsilon) = \tiles = \funt(\len-\epsilon)$. This means that there exists a segment with length $\len-\epsilon$ that visits $\tiles$ tiles, and thus $\funl(\tiles) \leq \len-\epsilon < \len$, in contradiction with \eqref{eq: theo funt, form: prop 1}. Therefore $\funt$ is discontinuous, from the right, at $\len$. By definition of $\funl$, \eqref{eq: theo funt, form: prop 1} implies that $\funt(\len) < \tiles$, and that there exists $\epsilon > 0$ such that $\funt(\len+h) = \tiles$ for $0 < h < \epsilon$. This means that
\begin{align}
\label{eq: theo funt, form: prop 2}
\funt(\len) &< \tiles, \\
\label{eq: theo funt, form: prop 3}
\lim_{h \rightarrow 0+} \funt(\len+h) &= \tiles,
\end{align}
that is, $\funt$ has a jump at $\len$. In addition, since the jump has unit height, it follows from \eqref{eq: theo funt, form: prop 2} and \eqref{eq: theo funt, form: prop 3}  that $\funt(\len) = \tiles-1$.

Conversely, assume that \eqref{eq: theo funt, form: prop 2} and \eqref{eq: theo funt, form: prop 3} hold for some $\len \in \mathbb R^+$, $\tiles \in \mathbb N$. From \eqref{eq: theo funt, form: prop 2} it follows that  $\funl(\tiles) \geq \len$. On the other hand, \eqref{eq: theo funt, form: prop 3} implies that $\funl(\tiles) \leq \len$. Thus $\funl(\tiles)=\len$.
\end{proof}

Although Theorem~\ref{theo: funt, form} is valid for $a \geq b$, the result could be applied for $a < b$ by simply swapping the values of $a$ and $b$. In other words, \eqref{eq: theo: funt, form; funt}--\eqref{eq: theo: funt, form; j}
% *!*
can be used for any grid if $a$, $b$ are interpreted as the largest and smallest sides of a tile, respectively.

\begin{theorem}
\label{theo: funl, form}
For $a, b \in \mathbb R^+$ and $\tiles \in \mathbb N$,
\begin{equation}
\label{eq: theo: funl, form; funl}
\funl(\tiles) = \sqrt{(\isoli-2)^2 a^2 + (\jsoli-2)^2 b^2}
\end{equation}
with
\begin{align}
\label{eq: theo: funl, form; i}
\isoli &= \max\left\{ \left\lfloor \frac {(2\tiles-1)b^2+5a^2}{2(a^2+b^2)} \right\rfloor, 2 \right\}, \\
\label{eq: theo: funl, form; j}
\jsoli &= \max\left\{ \left\lceil \frac {2\tiles a^2 + 3(b^2-a^2)}{2(a^2+b^2)} \right\rceil, 2 \right\}.
\end{align}
Equivalently,
\begin{equation}
\text{***new formula found by Alex; unless we can unify with the above}
% *** AA: Wrote a shot at how a unification might look in e-mail.
\end{equation}
This function is monotone increasing for $\tiles \geq 3$.
\end{theorem}

\begin{proof}
The $(i_\tiles,j_\tiles)$ pair in the minimal sufficient set $\mss$ corresponds to a maximum of $\tiles$ visited tiles. By construction of this set, any segment that visits $\tiles$ tiles must have length greater than $\sqrt{(i_\tiles-2)^2a^2 + (j_\tiles-2)^2b^2}$.

For $\tiles \geq 3$ the expressions \eqref{eq: theo: funl, form; i} and \eqref{eq: theo: funl, form; j} coincide with \eqref{eq: min suff set, form, i} and \eqref{eq: min suff set, form, j}. Therefore \eqref{eq: theo: funl, form; funl} gives the desired result.
	
For $\tiles \in \{1, 2\}$ both \eqref{eq: theo: funl, form; i} and \eqref{eq: theo: funl, form; j} equal $2$, and \eqref{eq: theo: funl, form; funl} gives $0$, which is the correct result.

***Proof of new formula

By Theorem~\ref{theo: funt, form}, $\funt$ has unit-height jumps at the values $\funl(\tiles)$, $\tiles \in \mathbb N$, $\tiles \geq 4$. This implies that $\funl$ is monotone increasing for $\tiles \geq 3$.
\end{proof}

***Comment on how the new formula has two terms with definite meanings: The first term is the distance-squared to the closest point on the diagonal, The second term is additional distance-squared incurred from rounding (i,j) to integers

Theorems~\ref{theo: funt, form} and \ref{theo: funl, form} not only give the solutions $\funt(\len)$ and $\funl(\tiles)$ to the two problems stated in \S\ref{part: intro}; they also provide a way to actually position a segment of length slightly greater than $\len$ or $\funl(\tiles)$ so that it visits $\tiles$ or $\funt(\len)$ tiles. Namely, the segment should have its endpoints respectively in the interior of two tiles separated $\isoli-1$ steps horizontally and $\jsoli-1$ steps vertically, with its exact position and orientation  adjusted to avoid any grid points.

It is interesting to consider the following particular cases: $\len \gg a,b$; $a \gg b$; and $a=b$. Regarding the first, from \eqref{eq: theo: funt, form; funt}--\eqref{eq: theo: funt, form; j}
% *!*
and from \eqref{eq: theo: funl, form; funl}--\eqref{eq: theo: funl, form; j}
% *!*
it is seen that for long segments the number of visited tiles and the segment length are approximately proportional, with
\begin{equation}
\label{eq: asympt}
\lim_{\len \rightarrow \infty} \frac{\funt(\len)}{\len}
= \lim_{\tiles \rightarrow \infty} \frac{\tiles}{\funl(\tiles)}
= \sqrt{1/a^2 + 1/b^2}.
\end{equation}

As for $a \gg b$, in this case the optimal canonical rectangle has $\isoli = 2$, and $\jsoli$ as large as allowed by $\len$ (direct problem) or as required by $\tiles$ (inverse problem), corresponding to an almost vertical segment. Obviously, for $a \gg b$ the length of the segment is best invested in increasing the number of tiles traversed vertically (but the segment should be slightly tilted to cross a vertical edge), and the asymptotic value of \eqref{eq: asympt} is approximately $1/b$.

For $a=b$, either from symmetry considerations or particularizing the formulas in the previous theorems it stems that the optimal orientation of the segment is close to $45^\circ$. This case will be dealt with in \S\ref{part: max: unit square grid, real lengths}, as it lends itself to simplified formulas.

Figure~\ref{fig: funt funl examples} shows $\funt$ and $\funl$ for several pairs of grid parameters $a$, $b$. The graphs illustrate some of the observations of the previous paragraphs. Indeed, the asymptotic slope in Figure~\ref{fig: funt examples}, or the inverse of the asymptotic slope in Figure~\ref{fig: funl examples}, is approximately $\sqrt{2}$ for $a, b=1$; and it is $1/b$ for the case $a=5,b=1$, or even for $a=5,b=1.5$ or $a=10,b=3$. Comparing the latter two cases it is also seen that scaling $a$, $b$ and $\len$ by the same factor does not alter $\funt(\len)$, and results in $\funl(\tiles)$ being scaled by that factor.

\begin{figure}
\centering%
\subfigure[Function $\funt$]{%
\label{fig: funt examples}%
\includegraphics[width=.49\textwidth]{funt_examples}%
}\hfill%
\subfigure[Function $\funl$]{%
\label{fig: funl examples}%
\includegraphics[width=.49\textwidth]{funl_examples}%
}%
\caption{Functions $\funt$ and $\funl$ for several pairs $a$, $b$
}%
\label{fig: funt funl examples}%
\end{figure}%


\subsection{Unit square grid with real-valued lengths}
\label{part: max: unit square grid, real lengths}

A square grid has $a=b$. For real-values segment lengths it can be further assumed that $a=1$. For $a \neq 1$ the results to be obtained apply with $\len$ replaced by $\len/a$.

Particularizing the results in \S\ref{part: max: arbitrary grid, real lengths} to $a=b=1$ obviously yields simpler formulas.

\begin{corollary}
\label{cor: funt, sq, form}
For a unit square grid with $\len \in \mathbb R^+$,
\begin{equation}
\label{eq: cor: funt, sq, form}
\funt(\len) = \isoli+\jsoli-1
\end{equation}
with
\begin{align}
\label{eq: cor: funt, sq, form; i}
\isoli &= \left\lceil \frac{1 + \Re \sqrt{2\len^2-1}}{2} \right\rceil + 1, \\
\label{eq: cor: funt, sq, form; j}
\jsoli &= \left\lceil \sqrt{\len^2-(\isoli-2)^2} \right\rceil + 1,
\end{align}
\end{corollary}

\begin{corollary}
\label{theo: funl, sq, form}
For a unit square grid, and for $\tiles \in \mathbb N$,
\begin{equation}
\funl(\tiles) = \begin{cases}
\displaystyle
0 & \text{for } \tiles =1, 2 \\[1.4mm]
\displaystyle
\frac{\tiles-3}{\sqrt{2}} & \text{for } \tiles \text{ odd, } \tiles \geq 3 \\[4.5mm]
\displaystyle
\sqrt{\frac{(\tiles-3)^2+1} {2}} & \text{for } \tiles \text{ even, } \tiles \geq 4,
\end{cases}
\end{equation}
or equivalently
\begin{equation}
\label{eq: theo: funt, sq, form; funl}
\funl(\tiles) = \begin{cases}
\displaystyle
0 & \text{for } \tiles =1, 2 \\[1.4mm]
\displaystyle
\sqrt{\left\lceil \frac{(\tiles-3)^2} {2} \right\rceil} & \text{for } \tiles \geq 3.
\end{cases}
\end{equation}
\end{corollary}

Furthermore, an even simpler formula can be obtained for $\funt$, as the next theorem shows.

\begin{theorem}
\label{theo: funt, sq, form}
For a unit square grid with $\len \in \mathbb R^+$,
\begin{equation}
\label{eq: theo: funt, sq, form; funt, with i, j}
\funt(\len) = \isoli+\jsoli-1
\end{equation}
with
\begin{align}
\label{eq: theo: funt, sq, form; i}
\isoli &= \left\lceil \frac{\len}{\sqrt{2}} \right\rceil + 1, \\
\label{eq: theo: funt, sq, form; j}
\jsoli &= \left\lceil \sqrt{\len^2-(\isoli-2)^2} \right\rceil + 1.
\end{align}
Equivalently,
\begin{equation}
\label{eq: theo: funt, sq, form; funt, simpler}
\funt(\len) = \left\lfloor \sqrt{2 \left\lceil \len^2 \right\rceil - 2} \right\rfloor + 3.
\end{equation}
\end{theorem}

\begin{proof}
The proof of \eqref{eq: theo: funt, sq, form; funt, with i, j} uses a variation of the minimal sufficient set $\mss$ defined in Proposition~\ref{prop: min suff set, form} that is more suited to this situation.
% ***``situation'' or ``case''?

For $a=b=1$, the set $\mss$ consists of points of the form $(i,i)$ and $(i,i-1)$, as is easily seen from Proposition~\ref{prop: min suff set, form}, and as illustrated in Figure~\ref{fig: pairs_bounds_1}. By symmetry, replacing each point $(i,i-1)$ by $(i-1,i)$ gives a set $\mss'$ which is also minimal sufficient. For this new set, the lower bounding line \eqref{eq: lower bound, line} can be replaced by the simpler $j=i$. The same approach used in the proof of Theorem~\ref{theo: funt, form} can be followed, but using this line. Thus $(\isolr, \jsolr)$ is obtained from
\begin{align}
(\isolr-2)^2 + (\jsolr-2)^2  &= \len^2, \\
\jsolr &= \isoli,
\end{align}
which gives
\begin{equation}
\label{eq: theo: funt, sq, form; proof 1}
\isolr = \len/\sqrt{2} + 2.
\end{equation}
The pair $(\isoli,\jsoli)$ resulting from \eqref{eq: theo: funt, sq, form; proof 1} is in $\mss'$, and is given in \eqref{eq: theo: funt, sq, form; i} and \eqref{eq: theo: funt, sq, form; j}. This establishes \eqref{eq: theo: funt, sq, form; funt, with i, j}.

To show \eqref{eq: theo: funt, sq, form; funt, simpler}, it is first noted that for $\tiles \geq 3$ Corollary~\ref{theo: funl, sq, form} gives
\begin{equation}
\funl(\tiles) = \sqrt{\left\lceil \frac{(\tiles-3)^2} {2} \right\rceil}.
\end{equation}
According to \eqref{eq: funt funl}, the function $\funt(\len)$ is given by the largest positive integer $t$ such that 
\begin{equation}
\label{eq: theo: funt, sq, form; proof 2}
\left\lceil \frac{(\tiles-3)^2} {2} \right\rceil < \len ^ 2.
\end{equation}
Since the left-hand side of \eqref{eq: theo: funt, sq, form; proof 2} is an integer, the condition of being strictly less than $\len^2$ is equivalent to
\begin{equation}
\left\lceil \frac{(\tiles-3)^2} {2} \right\rceil  \leq \left\lceil \len^2 \right\rceil  - 1,
\end{equation}
which in turn is the same as
\begin{equation}
\frac{(\tiles-3)^2} {2}\leq  \left\lceil \len^2 \right\rceil  - 1. 
\end{equation}
Finally, solving for $\tiles$ gives
\begin{equation}
\label{eq: theo: funt, sq, form; proof 3}
\tiles \leq \sqrt{2 \left\lceil \len^2 \right\rceil -2 } + 3.
\end{equation}
The desired quantity $\funt(\len)$, that is the largest positive integer $\tiles$ satisfying \eqref{eq: theo: funt, sq, form; proof 3}, is thus the right-hand side rounded down, as given by \eqref{eq: theo: funt, sq, form; funt, simpler}.
\end{proof}

From Theorem~\ref{theo: funt, sq, form} it is easily seen that odd values of $\funt(\len)$ correspond to $\isoli = \jsoli$, whereas even values are achieved with $\jsoli = \isoli+1$. Given $\tiles \geq 3$ with $\tiles$ odd, $\funt(\len) = \tiles$ if and only
\begin{equation}
\label{eq: square, odd max tiles, lengths}
\len \in \left( \frac{\tiles-3}{\sqrt{2}}, \frac{ \sqrt{(\tiles-1)^2+(\tiles-3)^2}}{2} \right].
\end{equation}
For $\tiles \geq 4$, $\tiles$ even, $\funt(\len) = \tiles$ if and only if
\begin{equation}
\label{eq: square, even max tiles, lengths}
\len \in \left(\frac{ \sqrt{(\tiles-2)^2+(\tiles-4)^2}}{2}, \frac{\tiles-2}{\sqrt{2}} \right].
\end{equation}


\subsection{Unit square grid with integer lengths}
\label{part: max: unit square grid, integer lengths}

A natural variation of the first two problems introduced in \S\ref{part: intro} is to consider $a=b=1$ with the additional restriction that the segment length can only be a positive integer (equivalently, the square grid has spacing $a$ and the segment length can only be an integer multiple of $a$).

The \emph{direct problem} in this setting corresponds to the restriction of the function $\funt$ to $\mathbb N$. This will be denoted as a function $\funti: \mathbb N \to \mathbb N$ for greater clarity, although obviously $\funti(\leni) = \funt(\leni)$ for all $\leni \in \mathbb N$. The sequence $\funti(\leni)$, $\leni \in \mathbb N$, which takes values $3, 5, 7, 8, 9, \ldots$, is depicted in Figure~\ref{fig: funti}. This is A346232 in the On-Line Encyclopedia of Integer Sequences \cite{OEIS_unitsq_int_dir}. For this sequence, the expression in Theorem~\ref{theo: funt, sq, form} simplifies in the obvious way, and the following properties hold.

\begin{figure}%
\centering%
\subfigure[Sequence $\funti$]{%
\label{fig: funti}%
\includegraphics[width=.49\textwidth]{funti}%
}\hfill%
\subfigure[Sequence $\funli$]{%
\label{fig: funli}%
\includegraphics[width=.49\textwidth]{funli}%
}%
\caption{Sequences $\funti$ and $\funli$
}%
\label{fig: funti funti}%
\end{figure}%

\begin{theorem}
\label{theo: funti}
For $\leni \in \mathbb N$,
% $\funti(\leni)$ can be computed as
\begin{equation}
\label{eq: funti leni}
\funti(\leni) = \left\lfloor \sqrt{2\leni^2-2} \right\rfloor + 3.
\end{equation}
In addition,
\begin{enumerate}
\item
This sequence is increasing, with $\funti(\leni+1)-\funti(\leni) \in \{1, 2\}$.
\item
There can be no more than $2$ consecutive increments equal to $1$.
\item
Increments equal to $2$ always appear isolated, except at the initial sequence terms $3, 5, 7$.
\end{enumerate}
\end{theorem}

\begin{proof}
The equality \eqref{eq: funti leni} stems from \eqref{eq: theo: funt, sq, form; funt, simpler} noting that $\len$ is an integer.

In order to prove that $\funti(\leni+1)-\funti(\leni) \in \{1,2\}$, consider the function $\genfun(\genvar) = \sqrt{2\genvar^2-2}$ for $\genvar \in \mathbb R$, $\genvar>1$. Its first derivative is
\begin{equation}
\genfun'(\genvar) = \frac {\sqrt{2} \, \genvar} {\sqrt{\genvar^2-1}},
\end{equation}
and its second derivative is easily seen to be negative. Therefore $\genfun'(\genvar)$ can be bounded for $\genvar \geq 3$ as
\begin{equation}
\label{eq: der bounds}
\lim_{\genvar \rightarrow \infty} \genfun'(\genvar) = \sqrt{2} < \genfun'(\genvar) < \genfun'(3) = 3/2.
\end{equation}
For $\leni \geq 2$, by the mean value theorem \cite[section~5.3]{Abbott15}, when $\leni$ is increased to $\leni+1$ the term $\sqrt{2\leni^2-2}$ in \eqref{eq: funti leni} has an increment that equals $\genfun'(\genvar)$ for some $\leni < \genvar < \leni+1$. Therefore
\begin{equation}
\label{eq: der bounds 2}
\sqrt{2} < \sqrt{2(\leni+1)^2-2} - \sqrt{2\leni^2-2} < 3/2.
\end{equation}
Since $1 < \sqrt{2}$ and $3/2 < 2$, \eqref{eq: der bounds 2} implies that $\funti(\leni+1)-\funti(\leni)$ can only take the values $1$ or $2$ for $\leni \geq 3$. In addition, $\funti(2)-\funti(1) = \funti(3)-\funti(2) = 2$, and thus the result holds for all $\leni \in \mathbb N$.

Using the first bound in \eqref{eq: der bounds 2} three times,
\begin{equation}
3\sqrt{2} < \sqrt{2(\leni+3)^2-2} - \sqrt{2\leni^2-2}.
\end{equation}
Considering that $4 < 3\sqrt{2}$, this implies that $\funti(\leni+3)-\funti(\leni) \geq 4$ for $\leni \geq 3$. Therefore at least one of the three increments from $\funti(\leni)$ to $\funti(\leni+3)$ is $2$. Since $\funti(2)-\funti(1) = \funti(3)-\funti(2) = 2$, the result holds for all $\leni \in \mathbb N$.

Similarly, using the second bound in \eqref{eq: der bounds 2} twice,
\begin{equation}
\sqrt{2(\leni+2)^2-2} - \sqrt{2\leni^2-2} < 3,
\end{equation}
which implies that $\funti(\leni+2)-\funti(\leni) \leq 3$ for $\leni \geq 3$. Therefore the two increments $\funti(\leni+1)-\funti(\leni)$ and $\funti(\leni+2)-\funti(\leni+1)$ cannot both be $2$ for $\leni \geq 3$.
\end{proof}

The \emph{inverse problem} with integer-length segments can be formulated as follows: given $\tiles \in \mathbb N$, find the \emph{minimum} integer length that allows visiting at least $\tiles$ tiles. Observe that in this case, unlike with real-valued lengths, there is indeed a minimum length, because every subset of $\mathbb N$ has a minimum. This can be expressed as a function $\funli: \mathbb N \to \mathbb N$:
\begin{equation}
\label{eq: funli funti}
\funli(\tiles) = \min\{\leni \in \mathbb N \st \funti(\leni) \geq \tiles\},
\end{equation}
which is related to the function $\funl$ corresponding to real-valued lengths by
\begin{equation}
\label{eq: funli funl}
\funli(\tiles) = \lfloor\funl(\tiles)\rfloor + 1.
\end{equation}
The converse to \eqref{eq: funli funti} is (compare to \eqref{eq: funt funl}):
\begin{equation}
\label{eq: funti funli}
\funti(\leni) = \max \{\tiles \in \mathbb N \st \funli(\tiles) \leq \leni\}.
\end{equation}
In view of \eqref{eq: funli funti} and \eqref{eq: funti funli}, $\funti$ and $\funli$ can be considered as ``pseudo-inverse'' sequences of each other.

The sequence $\funli(\tiles)$, $\tiles \in \mathbb N$ can be computed using \eqref{eq: theo: funt, sq, form; funl} and \eqref{eq: funli funl}, and has initial values $1, 1, 1, 2, 2, 3, 3, 4, 5 \ldots$, as shown in Figure~\ref{fig: funli}. This is A346693 in the On-Line Encyclopedia of Integer Sequences \cite{OEIS_unitsq_int_inv}. However, a slightly simpler expression can be obtained from \eqref{eq: funti leni} and \eqref{eq: funli funti}. This is established by the next theorem, which also states some properties of $\funli$, parallel to those of $\funti$.

\begin{theorem}
\label{theo: funli}
For $\tiles \in \mathbb N$,
% $\funli(\tiles)$ can be computed as
\begin{equation}
\label{eq: funli}
\funli(\tiles) = \begin{cases}
\displaystyle
1 & \text{for } \tiles \leq 3 \\[1.3mm]
\displaystyle
\left \lceil \sqrt{\frac{(\tiles-3)^2} 2 + 1} \ \right \rceil & \text{for } \tiles \geq 4.
\end{cases}
\end{equation}
In addition,
\begin{enumerate}
\item
This sequence is non-decreasing. Except for the initial run of $3$ equal values, it is formed by runs of $1$ or $2$ equal values, with an increment of $1$ between consecutive runs.
\item
There can be no more than $3$ different consecutive terms.
\item
A run of $2$ equal values always has $2$ different terms before and $2$ different terms after the run, except for the initial terms $1, 1, 1, 2, 2, 3, 3$.
\end{enumerate}
\end{theorem}

\begin{proof}
Using \eqref{eq: funti leni}, the inequality $\funti(\leni) \geq \tiles$ in \eqref{eq: funli funti} is written as
\begin{equation}
\left\lfloor \sqrt{2\leni^2-2} \right\rfloor + 3 \geq \tiles.
\end{equation}
Since the right-hand side is an integer, this is equivalent to
\begin{equation}
\label{eq: theo funli ineq}
\sqrt{2\leni^2-2} \geq \tiles-3.
\end{equation}
For $\tiles \geq 4$, taking squares and rearranging gives
\begin{equation}
\leni \geq \left \lceil \sqrt{\frac{(\tiles-3)^2} 2 + 1} \ \right \rceil,
\end{equation}
which combined with \eqref{eq: funli funti} yields the second part of \eqref{eq: funli}. The first part results from noting that $\tiles-3 \leq 0$ for $\tiles \leq 3$, and thus $\leni=1$ satisfies \eqref{eq: theo funli ineq}.

The stated properties for $\funli$ follow directly from those of $\funti$ established by Theorem~\ref{theo: funti}.
\end{proof}


\section{Probabilistic characterization for a random segment}
\label{part: rand}

Given $\len \in \mathbb R^+$, consider a segment of length $\len$ with uniformly random position and orientation. Specifically, the coordinates $x_1$, $y_1$ of the first endpoint are independent random variables uniformly distributed on $[0,a)$ and $[0,b)$ respectively. The orientation $\theta$ of the segment is uniformly distributed on $[0,2\pi)$. The variables $x_1$, $y_1$ and $\theta$ determine the coordinates $x_2$, $y_2$ of the second endpoint.

Each realization of the random segment gives rise to a canonical rectangle, whose normalized dimensions $i$ and $j$ are thus random variables, as is the number $\tiles$ of visited tiles. Except for a set of realizations with zero probability, $i$ and $j$ are at least $1$, and $\tiles = i+j-1$ tiles. Note that $i$ and $j$ are not statistically independent. 


\subsection{Arbitrary grid with real-valued lengths}
\label{part: probmax: arbitrary grid, real lengths}

Let $\funta: \mathbb R^+ \to \mathbb R^+$ be defined such that $\funta(\len)$ gives the average number of tiles visited by a random segment of length $\len$, with the distributions specified in \S\ref{part: rand}. This function can be easily computed using the fact that
\begin{equation}
\label{eq: funta E[i] E[j]}
\funta(\len) = \E[\tiles] = \E[i]+\E[j]-1,
\end{equation}
and noting that events of probability $0$, such as $x_1=a$ or the segment passing through a grid point, can be disregarded.

\begin{theorem}
\label{theo: funta, form}
Given $a, b, \len \in \mathbb R^+$, consider a grid with parameters $a, b$ and a uniformly random segment of length $\len$, as defined above. The average number of tiles visited by the segment, $\funta(\len)$, is 
\begin{equation}
\label{eq: funta, form}
\funta(\len) = \frac{2\len}{\pi}\left(\frac 1 a + \frac 1 b\right) + 1.
\end{equation}
\end{theorem}

\begin{proof}
First, suppose the grid is simplified to just horizontal lines a height of $b$ apart. This matches the setup of the 1733 Buffon's needle problem, except that here the length $\len$ of the needle may exceed the spacing $b$, allowing it to cross multiple lines. As shown in \cite{Ramaley69}, the expected (i.e., average) number of lines crossed equals
$$ \frac{2\len}{\pi b}.$$
Where $b<\len$, this expectation matches the probability of the needle crossing a grid line, since it cannot cross more than one.

Now consider again a grid of width $a$ and height $b$, as studied by Laplace as an extension to Buffon's original needle problem \cite{Arnow94}. The grid crossings decompose into crossings of horizontal and vertical grid lines, respectively. By linearity of expectation, the expected number of crossings is the sum of the respective expectations for parallel lines of width $a$ and $b$ respectively, giving:
\[
\frac{2\len}{\pi}\left(\frac 1 a + \frac 1 b\right)
\]
As noted in Proposition \ref{prop: i+j-1}, the number of tiles visited by a segment is the count of its grid line crossings plus $1$, unless it exactly crosses any grid points, but again that occurs with probability $0$ and therefore it does not affect the expectation. Thus, $\funta(\len)$ is the above quantity plus $1$.
\end{proof}

In view of Theorem~\ref{theo: funta, form}, the average number of visited tiles as a function of the segment length has a very simple form, namely an affine function. Conversely, for any $\tiles>1$ it is immediate to compute the length of a random segment that visits $\tiles$ tiles on average, given as $\funta^{-1}(\tiles)$.

In spite of the dependence between the random variables $i$ and $j$, their marginal distributions have relatively simple analytic expressions, as established by the next proposition.

For $0 \leq \genvar \leq 1$, let
\begin{equation}
\label{eq: f}
f(\genvar) = \int_0^r \arccos z \diff z = \genvar \arccos \genvar - \sqrt{1-\genvar^2} + 1.
\end{equation}

\begin{proposition}
\label{prop: Pr i}
Given $a, b, \len \in \mathbb R^+$, consider a grid with parameters $a, b$ and a uniformly random segment of length $\len$, as defined above. Let the random variables $i$, $j$ represent the normalized dimensions of the canonical rectangle. For $n \in \mathbb N$,
\begin{equation}
\label{eq: Pr i geq n}
\Pr[i \geq n] = \begin{cases}
\displaystyle
1 &\text{if\ \ } \displaystyle n =1 \\[1 mm]
\displaystyle
\frac{2\len}{\pi a} \left(f\left(\frac{a(n-1)}{\len}\right)-f\left(\frac{a(n-2)}{\len} \right)\right) &\text{if\ \ } \displaystyle 2 \leq n < \frac \len a + 1 \\[4 mm]
\displaystyle
\frac{2\len}{\pi a}\,\, \left(1 - f\left(\frac{a(n-2)}{\len}\right)\right) &\text{if\ \ } \displaystyle \frac\len a + 1 \leq n < \frac\len a+2 \\[3 mm]
\displaystyle
0 &\text{if\ \ } \displaystyle \frac \len a + 2 \leq  n; \\
\end{cases}
\end{equation}
and $\Pr[j \geq n]$ is given by the same expressions with $a$ replaced by $b$.
\end{proposition}

\begin{proof}
Clearly, $\Pr[i \geq 1]=1$. In the following it will be assumed that $n \geq 2$. The basic idea is to compute $\Pr[i \geq n]$ conditioned on $(x_1,y_1)$ (or, as will be seen, only on $x_1$), and then to average over $x_1$ and $y_1$ (actually only over $x_1$).

Given the coordinates $(x_1, y_1)$ of the first endpoint of the segment, with $0 \leq x_1 \leq a$, $0 \leq y_1 \leq b$, the second endpoint $(x_2, y_2)$ lies on a circle with radius $\len$ centered at $(x_1,y_1)$, as shown in Figure~\ref{fig: Pr_i}. The segment orientation is a random angle $\theta$ uniformly distributed on $[0,2\pi)$. It is clear from the figure that $i \geq n$ if and only if $x_2 \geq a(n-1)$ or $x_2 \leq -a(n-2)$; and these events are exclusive for $n \geq 2$. Thus
\begin{equation}
\label{eq: Pr i cond}
\Pr[i \geq n \cond x_1, y_1] = \Pr[x_2 \geq a(n-1) \cond x_1, y_1] + \Pr[x_2 \leq -a(n-2) \cond x_1, y_1].
\end{equation}
The two conditional probabilities on the right-hand side of \eqref{eq: Pr i cond} are different in general. However, averaging over $x_1, y_1$ gives, by symmetry, $\Pr[x_2 \geq a(n-1)] = \Pr[x_2 \leq -a(n-2)]$. In addition, the coordinate $y_1$ does not have any influence on these events, and therefore conditioning on $x_1, y_1$ is the same as conditioning on $x_1$. This implies that, for $n \geq 2$,
\begin{equation}
\label{eq: Pr i = 2 Pr}
\Pr[i \geq n] = 2 \Pr[x_2 \geq a(n-1)] = 2 \E[\Pr[x_2 \geq a(n-1) \cond x_1]].
\end{equation}

\begin{figure}
\centering%
\subfigure[$x_2$ can exceed $a(n-1)$ for all $x_1$, $0 \leq x_1 \leq a$]{%
\label{fig: Pr_i_full}%
\includegraphics[width=.58\textwidth]{Pr_i_full_1p35}%
}\\%\hfill%
\subfigure[$x_2$ can exceed $a(n-1)$ only if $a(n-1)-\len \leq x_1 \leq a$]{%
\label{fig: Pr_i_notfull}%
\includegraphics[width=.58\textwidth]{Pr_i_notfull_1p35}%
}%
\caption{Conditions for the normalized width of the canonical rectangle, $i$, to be equal or greater than a given $n$. Example with $a=1.35$, $b=1$, $n=3$
}%
\label{fig: Pr_i}
\end{figure}%

Consider the event $x_2 \geq a(n-1)$ conditioned on $x_1$, with $n \geq 2$. There are three possibilities depending on $x_1$, $n$ and $\len$. If $a(n-1) < \len$, regardless of $x_1$ the length $\len$ is enough for $x_2$ to exceed $a(n-1)$ for some angles $\theta$. This is depicted in Figure~\ref{fig: Pr_i_full}, where the section of the arc with solid line represents those angles for which $x_2 > a(n-1)$. If $a(n-2) < \len \leq  a(n-1)$, the length will be enough provided that $x_1 \geq a(n-1)-\len$, which corresponds to the shaded region in Figure~\ref{fig: Pr_i_notfull}. Lastly, if $\len \leq  a(n-2)$ it is not possible for $x_2$ to exceed $a(n-1)$. Note that the coordinate $y_1$ is irrelevant to this.

In the first two cases above, the probability that $x_2 \geq a(n-1)$, conditioned on $x_1$, is the length of the arc to the right of the line $x=a(n-1)$ divided by $2\pi\len$, that is,
\begin{equation}
\label{eq: Pr x_2 geq a(n-1) cond}
\Pr[x_2 \geq a(n-1) \cond x_1] = \frac 1 \pi \arccos \frac{a(n-1)-x_1}{\len}.
\end{equation}
In the first case $x_1$ has a uniform distribution on $(0,a)$, and $\Pr[x_2 \geq a(n-1)]$ is easily obtained from \eqref{eq: Pr x_2 geq a(n-1) cond} as
\begin{equation}
\label{eq: Pr x_2 geq a(n-1), first case}
\begin{split}
\Pr[x_2 \geq a(n-1)] &= \frac 1 {\pi a} \int_0^a\arccos \frac{a(n-1)-x_1}{\len} \diff x_1 \\
&= \frac{\len}{\pi a}\,\, \left( f\left( \frac{a(n-1)}{\len} \right) - f\left( \frac{a(n-2)}{\len} \right) \right),
\end{split}
\end{equation}
where the function $f$ is defined in \eqref{eq: f}. Substituting into \eqref{eq: Pr i = 2 Pr} yields the result in \eqref{eq: Pr i geq n}, second line.

The second case is similar, but the integration over $x_1$ is from $a(n-1)-\len$ to $a$. Noting that $f(1)=1$, this gives
\begin{equation}
\label{eq: Pr x_2 geq a(n-1), second case}
\Pr[x_2 \geq a(n-1)] = \frac{\len}{\pi a}\,\, \left( 1 - f\left( \frac{a(n-2)}{\len} \right) \right),
\end{equation}
which combined with \eqref{eq: Pr i = 2 Pr} yields the expression in \eqref{eq: Pr i geq n}, third line.

The third case obviously gives $\Pr[i \geq n] = 0$, as in \eqref{eq: Pr i geq n}, fourth line.

The above arguments can be applied to $\Pr[j \geq n]$ if the $x$ and $y$ axes are interchanged. Thus the result is the same with $a$ replaced by $b$.
\end{proof}

The results in Theorem~\ref{theo: funta, form} and Proposition~\ref{prop: Pr i} make clear the relationship between the problem considered in this section here and Buffon's needle problem, i.e.~the probability that a random segment of fixed length crosses a line in a regular structure of parallel strips \cite[section 1.1]{Mathai99}. Firstly, since the number $\pi$ is involved in \eqref{eq: funta, form}, it is possible to design a simple probabilistic experiment to estimate the value of $\pi$, as in Buffon's original experiment. For example, choosing $a=b=\len=1$ gives $\funta(\len) = 1+1/\pi$.

Secondly, a grid with $b \rightarrow \infty$ corresponds to Buffon's arrangement of parallel strips with spacing $a$. Thus
\begin{equation}
\label{eq: number of lines crossed, Buffon}
\lim_{b \rightarrow \infty} \funta(\len)-1 = \frac{2\len}{\pi a}
\end{equation}
gives the average number of lines crossed in Buffon's experiment. For $\len \leq a$ the segment can cross at most one line, and \eqref{eq: number of lines crossed, Buffon} coincides with the probability of crossing \cite[section 1.1]{Mathai99}.

Lastly, $\Pr[i \geq n]$ as computed in Proposition~\ref{prop: Pr i} for $n \geq 2$ can be seen as a generalization of the probability of crossing at least one line in Buffon's experiment, when a needle endpoint is only allowed to move in a narrower region of width $n-1$ times smaller than the width of the strips (instead of across the full strip as in Buffon's setting).

***Maybe a graph comparing maximum and average. Or compute/plot their ratio. The asymptotic slopes are $\sqrt(1/a^2+1/b^2)$ for $\funt$ and $2/\pi(1/a+1/b)$. It may be interesting to consider the ratio of asymptotic slopes, as a function of $a/b$. It is maximum for $a=b$, and equals $2\sqrt 2/\pi = 0.9003$. It tends to $2/\pi$ for $a/b \rightarrow \infty$ and for $a/b \rightarrow 0$. The minimum number of tiles that can be visited with non-zero probability (corresponding to an n times 1 canonical rectangle if a>=b) can also be plotted.

The probability of visiting the maximum number of tiles for a rectangular grid is difficult to compute, due to the irregularity of the minimal sufficient set (see \S\ref{part: fund results}). In the square case, however, the simplicity of the set makes the problem more tractable. 


\subsection{Unit square grid with real-valued lengths}
\label{part: probmax: unit square grid, real lengths}

Consider a square grid with unit spacing, $a=b=1$. Again, the results to follow can be applied to a square grid with spacing $a \neq 1$ if $\len$ is replaced by $\len/a$.

For a random segment with length $\len \in \mathbb R^+$ on a unit square grid, let the function $\probmax: \mathbb R^+ \to [0,1]$ be defined such that $\probmax(\len)$ gives the probability that the segment visits the maximum possible number of tiles, $\funt(\len)$. This function is characterized by the next theorem.

For $u, v \in \mathbb N$, $\genvar \in \mathbb R^+$, let
\begin{equation}
\label{eq: g def}
g(\genvar, u, v) = \int_{\arcsin \frac u {2r}}^{\arccos \frac u {2r}} \left( r \sin \theta - \frac u 2 \right) \left( r \cos \theta - \frac v 2 \right) \diff \theta.
\end{equation}
Using the identities $\cos^2 \alpha = 1-\sin^2 \alpha$ and $\cos(2\alpha) = 2\cos^2\alpha-1 = 1 - 2\sin^2\alpha$, the integral in \eqref{eq: g def} is computed as
\begin{equation}
\label{eq: g fin}
\begin{split}
g(\genvar, u, v) &= \frac 1 {2\pi} \biggl(
\left(\arccos\frac{u}{2\genvar}-\arcsin\frac{v}{2\genvar}\right) u v + 2\genvar^2 + \frac{u^2} 2 + \frac{v^2} 2 \\
& \quad  - u \sqrt{4\genvar^2-v^2} - v \sqrt{4\genvar^2-u^2} \biggr).
\end{split}
\end{equation}

\begin{theorem}
\label{theo: probmax, sq}
Given $\len \in \mathbb R^+$, consider a unit square grid and a uniformly random segment of length $\len$, as previously defined. The probability $\probmax(\len)$ that the segment visits the maximum number of tiles $\funt(\len)$ is
\begin{equation}
\label{eq: probmax}
\begin{split}
\probmax(\len) & = g\left(\len, 
\tiles-3, \tiles-3 \right) \quad\ \text{for } \tiles \text{ odd, } \textstyle \len \in \left( \frac{\tiles-3}{\sqrt{2}}, \frac{\sqrt{(\tiles-5)^2+(\tiles-1)^2}} 2 \right]; \\
\probmax(\len) & = g\left(\len, \tiles-3, \tiles-3 \right) + 2 g\left(\len, \tiles-5, \tiles-1 \right) \\
& \text{for } \tiles \text{ odd, } \textstyle \len \in \left (\frac{\sqrt{(\tiles-5)^2+(\tiles-1)^2}} 2,  \frac{\sqrt{(\tiles-3)^2+(\tiles-1)^2}} 2 \right]; \\
\probmax(\len) & = 2 g\left(\len, \tiles-4, \tiles-2 \right) \quad \text{for } \tiles \text{ even, } \textstyle \len \in \left( \frac{\sqrt{(\tiles-4)^2+(\tiles-2)^2}} 2, \frac{\sqrt{(\tiles-6)^2+\tiles^2}} 2 \right]; \\
\probmax(\len) & = 2 g\left(\len, \tiles-4, \tiles-2 \right) + 2 g\left(\len, \tiles-6, \tiles \right) \\
& \text{for } \tiles \text{ even, } \textstyle \len \in \left( \frac{\sqrt{(\tiles-6)^2+\tiles^2}} 2, \frac{\tiles-2}{\sqrt{2}} \right].
\end{split}
\end{equation}
\end{theorem}

\begin{proof}
The approach is similar to that used in the proof of Proposition~\ref{prop: Pr i}, but conditioning on the segment orientation $\theta$ instead of on the location of its first endpoint.

Consider a length $\len$ with corresponding maximum number of tiles $\tiles = \funt(\len)$. The first endpoint of the segment is assumed to be in the reference tile with lower-left corner $(0,0)$. The segment visits $\tiles$ tiles almost surely if and only if its second endpoint is in a tile with lower-left corner $(i-1,j-1)$, $i,j\geq 1$, $i+j-1=\tiles$, or in a tile symmetrical to this in the other three quadrants of the plane. Figure~\ref{fig: probmax_possible_tiles} shows the reference tile, with solid line, and some of the tiles that fulfil this condition, with dashed line, for $\tiles=5$. The desired probability can be computed by considering only the tiles in the first quadrant and multiplying by $4$.

% ***Does this figure add something, or is it better to remove it?
\begin{figure}
\centering%
\includegraphics[width=.52\textwidth]{probmax_possible_tiles}%
\caption{Tiles in which the second endpoint can be for a given number of visited tiles $\tiles$ in a square grid (example for $\tiles=5$)
}%
\label{fig: probmax_possible_tiles}%
\end{figure}%

For any $i,j$ with $i+j-1=\tiles$ and for a given orientation $\theta$, the segment goes from the reference tile to that with lower-left corner $(i-1,j-1)$ if and only if shifting the segment so that its second endpoint has coordinates $(i-1,j-1)$ results in the first endpoint being in the reference tile. It cannot be the case that the segment ``overshoots'' past this tile, because that would result in a number of visited tiles exceeding the assumed maximum $\tiles$.

\begin{figure}
\centering%
\subfigure[The second endpoint is in the tile with lower-left corner $((\tiles-1)/2,(\tiles-1)/2)$]{%
\label{fig: probmax_funt_odd_diag}%
\includegraphics[width=.56\textwidth]{probmax_funt_odd_diag}%
}\\%\hfill%
\subfigure[The second endpoint is in the tile with lower-left corner $((\tiles-3)/2,(\tiles+1)/2)$]{%
\label{fig: probmax_funt_odd_offdiag}%
\includegraphics[width=.56\textwidth]{probmax_funt_odd_offdiag}%
}%
\caption{Segment orientations and positions of the first endpoint within the reference tile for a given number $\tiles$ of visited tiles. Example for odd $\tiles$
}%
\label{fig: probmax_funt_odd}%
\end{figure}%

There is a range of possible values of $\theta$ for which the above condition is satisfied. This range corresponds to the part of the arc with solid line in Figure~\ref{fig: probmax_funt_odd}. For convenience, the angle $\theta$ is defined clockwise from the downward direction. For each $\theta$ in the allowed range, the valid positions for the first endpoint of the (shifted) segment are in the shaded rectangle, whose dimensions depend on $\theta$. The area occupied by this rectangle is the probability $\probmax_{i-1,j-1}(\len,\theta)$ that the segment goes from the reference tile to that with lower-left corner $(i-1,j-1)$ conditioned on $\theta$. The desired probability, $\probmax(\len)$, is obtained by averaging $\probmax_{i-1,j-1}(\len, \theta)$ over $\theta$ and summing over all $i-1,j-1$ that can be reached from the reference tile.

There are two situations depending on whether $\tiles$ is odd or even. Consider $\tiles$ odd first. Under this assumption, the range of lengths corresponding to $\tiles$ is given by \eqref{eq: square, odd max tiles, lengths}. For any length in this interval, there are some positions within the reference tile from which the tile with lower-left coordinate $((\tiles-1)/2, (\tiles-1)/2)$ can be reached. Equivalently, the shifted segment with one endpoint at $((\tiles-1)/2, (\tiles-1)/2)$ can reach the reference tile. This is illustrated in Figure~\ref{fig: probmax_funt_odd_diag}. In addition, if 
\begin{equation}
\label{eq: probmax len odd2}
\len > \frac{\sqrt{(\tiles-5)^2 + (\tiles-1)^2}}{2}
\end{equation}
the two tiles with lower-left coordinates $((\tiles-3)/2, (\tiles+1)/2)$ and $((\tiles+1)/2, (\tiles-3)/2)$ are also reachable from the reference tile; or equivalently the shifted segment can reach the reference tile, as shown in Figure~\ref{fig: probmax_funt_odd_offdiag}. This can only happen for $\tiles \geq 5$ (for $\tiles=3$ the inequality \eqref{eq: probmax len odd2} cannot be satisfied for lengths in the range given by \eqref{eq: square, odd max tiles, lengths}). In this case, by symmetry, each of those two tiles contributes the same probability. Other tiles corresponding to the same $\tiles$ need not be considered, because they cannot be reached with lengths satisfying \eqref{eq: square, odd max tiles, lengths}.

For $\tiles$ even, which corresponds to lengths in the interval \eqref{eq: square, even max tiles, lengths}, the two tiles with lower-left coordinates $(\tiles/2-1, \tiles/2)$ and $(\tiles/2, \tiles/2-1)$ can always be reached from some positions within the reference tile. In addition, if
\begin{equation}
\label{eq: probmax len even2}
\len > \frac{\sqrt{((\tiles-6)^2 + \tiles^2}}{2}
\end{equation}
the two tiles with lower-left coordinates $(\tiles/2-2, \tiles/2+1)$ and $(\tiles/2+1, \tiles/2-2)$ have to be considered too. This can only happen for $\tiles \geq 8$. No other tiles can be reached from the reference tile.

Thus, two cases need to be distinguished for $\tiles$ odd, depending on whether \eqref{eq: probmax len odd2} is satisfied or not; and similarly two cases exist for $\tiles$ even, depending on whether \eqref{eq: probmax len even2} holds or not. These are, respectively, the four cases in \eqref{eq: probmax}.

In the first case, as has been argued, only the tile with lower-left coordinates $((\tiles-1)/2, (\tiles-1)/2)$ is reachable. For a given $\theta$, the conditional probability $\probmax_{(\tiles-1)/2, (\tiles-1)/2}(\len, \theta)$ is the area of the shaded rectangle in Figure~\ref{fig: probmax_funt_odd_diag}:
\begin{equation}
\label{eq: probmax: probmax theta odd}
\probmax_{(\tiles-1)/2, (\tiles-1)/2}(\len, \theta) = \left(\len\sin\theta - \frac{\tiles-3}2\right) \left(\len\cos\theta - \frac{\tiles-3}2\right).
\end{equation}
The range of allowed values for $\theta$, as can be seen from the figure, is $(\theta_0, \theta_1)$ with
\begin{align}
\label{eq: odd theta 0}
\theta_0 & = \arcsin\frac{\tiles-3}{2\len}, \\
\label{eq: odd theta 1}
\theta_1 & = \arccos\frac{\tiles-3}{2\len}.
\end{align}
Computing the average of \eqref{eq: probmax: probmax theta odd} over $\theta$, multiplying by $4$ to include all quadrants and comparing with \eqref{eq: g def} gives $\probmax(\len)$ as
\begin{equation}
\label{eq: probmax: probmax odd}
\begin{split}
\probmax(\len) & = 4 \int_{\theta_0}^{\theta_1} \frac{\probmax_{(\tiles-1)/2, (\tiles-1)/2}(\len, \theta)}{2\pi} \diff \theta \\
& = \frac 2 \pi \int_{\arcsin\frac{\tiles-3}{2\len}}^{\arccos\frac{\tiles-3}{2\len}} \left( \len\sin\theta - \frac{\tiles-3} 2 \right)  \left( \len\cos\theta - \frac{\tiles-3} 2 \right) \diff \theta \\
& = g\left( \len, \tiles-3, \tiles-3 \right ),
\end{split}
\end{equation}
in accordance with \eqref{eq: probmax}.

For the second case in \eqref{eq: probmax}, $\probmax(\len)$ is obtained as in the preceding paragraph plus an additional term corresponding to the contribution of the tile with lower-left corner $((\tiles-3)/2, (\tiles+1)/2)$, multiplied by $2$ to account for its symmetrical tile $((\tiles+1)/2, (\tiles-3)/2)$ and by $4$ to include all quadrants. Observing the shaded rectangle in Figure~\ref{fig: probmax_funt_odd_offdiag},
\begin{equation}
\label{eq: probmax: probmax theta odd2}
\probmax_{(\tiles-3)/2, (\tiles+1)/2}(\len, \theta) = \left(\len\sin\theta - \frac{\tiles-5}2\right) \left(\len\cos\theta - \frac{\tiles-1}2\right).
\end{equation}
The integration interval $(\theta_0, \theta_1)$ is in this case
\begin{align}
\theta_0 & = \arcsin\frac{\tiles-5}{2\len}, \\
\theta_1 & = \arccos\frac{\tiles-1}{2\len}.
\end{align}
The additional contribution to $\probmax(\len)$, given by
\begin{multline}
8 \int_{\theta_0}^{\theta_1} \frac{\probmax_{(\tiles-3)/2, (\tiles+1)/2}(\len, \theta)}{2\pi} \diff \theta \\
= \frac 4 \pi \int_{\arcsin\frac{\tiles-5}{2\len}}^{\arccos\frac{\tiles-1}{2\len}} \left( \len\sin\theta - \frac{\tiles-5} 2 \right)  \left( \len\cos\theta - \frac{\tiles-1} 2 \right) \diff \theta,
\end{multline}
is recognized to be $2 g(\len, \tiles-5, \tiles-1)$. This proves the second equality in \eqref{eq: probmax}.

The expressions for the third and fourth cases in \eqref{eq: probmax}, corresponding to $\tiles$ even, are established analogously.
\end{proof}

The technique used in the proof of Theorem~\ref{theo: probmax, sq} could in principle be used for obtaining the probability that the number of tiles visited by the segment equals or exceeds any given value $t < \funt(\len)$. The resulting expressions, however, are cumbersome, because more cases (more subintervals for the length) need to be distinguished depending on how many tiles with lower-left corner $(i-1,j-1)$ such that $i+j-1=t$ can be reached from the reference tile.

Figure~\ref{fig: probmax_len} shows the probability $\probmax(\len)$ of visiting the maximum number of tiles on a unit square grid, as given by \eqref{eq: probmax}. As $\len$ grows, $\probmax(\len)$ has a jump when the maximum number of tiles that can be visited increases by $1$. This happens when $\len$ equals the right endpoint of the interval \eqref{eq: square, odd max tiles, lengths} for $\tiles$ odd or of \eqref{eq: square, even max tiles, lengths} for $\tiles$ even. Let these length values be denoted as $\len_\tiles$:
\begin{equation}
\len_\tiles = \begin{cases}
\displaystyle
\frac{\sqrt{(\tiles-3)^2 + (\tiles-1)^2}} {2} & \text{ for $\tiles$ odd, $\tiles \geq 3$} \\
\displaystyle
\frac{\tiles-2}{\sqrt{2}} & \text{ for $\tiles$ odd, $\tiles \geq 4$}.
\end{cases}
\end{equation}
For example, the first continuous section seen in Figure~\ref{fig: probmax_len} corresponds to a maximum number of tiles $\tiles=3$, for lengths in the interval $(0, \len_3]$, with $\len_3= 1$. The second corresponds to $\tiles=4$, for lengths in $(\len_3, \len_4]$, with $\len_4= \sqrt{2}$. Within each continuous section the probability monotonically increases from $0$ to a maximum value. The heights of the maxima follow a different trend**better word?** for odd and even $\tiles$, as can be seen in the figure; but in each case they are asymptotically proportional to $1/\len_\tiles$. This is established by the next result.

\begin{figure}%
\centering%
\includegraphics[width=.75\textwidth]{probmax_len}%
\caption{Probability $\probmax(\len)$ that a random segment of length $\len$ visits the maximum number of tiles%
}%
\label{fig: probmax_len}%
\end{figure}%

\begin{proposition}
The function $\probmax$ has the following asymptotic behaviour:
\begin{align}
\label{eq: probmax liminf}
\liminf_{\len \rightarrow \infty}\, \probmax(\len) & = 0 \\ 
\label{eq: probmax lim odd}
\lim_{\substack{\tiles \rightarrow \infty \\
\tiles \ \mathrm{odd}}}\, \tiles \probmax(\len_\tiles) & = \frac 2 \pi \\
\label{eq: probmax lim even}
\lim_{\substack{\tiles \rightarrow \infty \\ \tiles \ \mathrm{even}}}\, \tiles \probmax(\len_\tiles) & = \frac 8 {3\pi} \\
\label{eq: probmax limsup}
\limsup_{\len \rightarrow \infty}\, \len \probmax(\len) & = \frac {4\sqrt{2}}{3\pi}.
\end{align}
\end{proposition}

\begin{proof}
The probability $\probmax(\len)$ becomes $0$ whenever the length causes the maximum number of visited tiles to increase by $1$. This establishes \eqref{eq: probmax liminf}.

For \eqref{eq: probmax lim odd} it suffices to note that
\begin{align}
\label{eq: tedious limit, odd 1}
\lim_{\tiles \rightarrow \infty}\, \tiles g\left(\frac{\sqrt{(\tiles-3)^2+(\tiles-1)^2}} 2, \tiles-3, \tiles-3 \right) &= \frac 2 {3\pi} \\
\label{eq: tedious limit, odd 2}
\lim_{\tiles \rightarrow \infty}\, \tiles g\left(\frac{\sqrt{(\tiles-3)^2+(\tiles-1)^2}} 2, \tiles-5, \tiles-1 \right)
& = \frac 2 {3\pi},
\end{align}
as can be checked using L'H\^opital's rule \cite[section~5.3]{Abbott15}.
%***I think. It's very tedious by hand. I used Maple to compute the limit, and then checked it numerically. Maybe one or two intermediate steps from applying L'H\^opital's rule should be included. Perhaps those can be obtained with Maple too, and this part can be rewritten.
Combining these expressions with the second equality in \eqref{eq: probmax} yields \eqref{eq: probmax lim odd}.

Similarly,
\begin{align}
\label{eq: tedious limit, even 1}
\lim_{\tiles \rightarrow \infty}\, \tiles g\left(\frac{\tiles-2}{\sqrt 2}, \tiles-4, \tiles-2 \right) &= \frac 2 {3\pi} \\
\label{eq: tedious limit, even 2}
\lim_{\tiles \rightarrow \infty}\, \tiles g\left(\frac{\tiles-2}{\sqrt 2}, \tiles-6, \tiles \right)
& = \frac 2 {3\pi},
\end{align}
and combining with the fourth equality in \eqref{eq: probmax} gives \eqref{eq: probmax lim even}.

For large $\tiles$, $\len_\tiles$ asymptotically approaches $\tiles/\sqrt{2}$. Using this into \eqref{eq: probmax lim even}, which is greater than \eqref{eq: probmax lim odd}, yields \eqref{eq: probmax limsup}.
\end{proof}


\bibliographystyle{plain}
\bibliography{bibliogr/lista_local}


\end{document}